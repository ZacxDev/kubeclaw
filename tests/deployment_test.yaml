suite: deployment
templates:
  - templates/deployment.yaml
  - templates/configmap.yaml
  - templates/configmap-skills.yaml
  - templates/configmap-workspace.yaml
set:
  agentName: testbot
  existingSecret: devpod-secrets
tests:
  - it: should create a Deployment
    asserts:
      - isKind:
          of: Deployment
        template: templates/deployment.yaml

  - it: should set correct name and namespace
    asserts:
      - equal:
          path: metadata.name
          value: testbot-devpod
        template: templates/deployment.yaml
      - equal:
          path: metadata.namespace
          value: devpod-testbot
        template: templates/deployment.yaml

  - it: should use default image
    asserts:
      - matchRegex:
          path: spec.template.spec.containers[0].image
          pattern: your-registry/openclaw:latest
        template: templates/deployment.yaml

  - it: should use custom image when set
    set:
      image:
        repository: custom-registry/openclaw
        tag: v1.0.0
    asserts:
      - equal:
          path: spec.template.spec.containers[0].image
          value: "custom-registry/openclaw:v1.0.0"
        template: templates/deployment.yaml

  - it: should set resource requests and limits
    asserts:
      - equal:
          path: spec.template.spec.containers[0].resources.requests.memory
          value: "512Mi"
        template: templates/deployment.yaml
      - equal:
          path: spec.template.spec.containers[0].resources.requests.cpu
          value: "250m"
        template: templates/deployment.yaml
      - equal:
          path: spec.template.spec.containers[0].resources.limits.memory
          value: "2Gi"
        template: templates/deployment.yaml

  - it: should set custom resources
    set:
      resources:
        requests:
          memory: "1Gi"
          cpu: "500m"
        limits:
          memory: "4Gi"
          cpu: "4000m"
    asserts:
      - equal:
          path: spec.template.spec.containers[0].resources.requests.memory
          value: "1Gi"
        template: templates/deployment.yaml
      - equal:
          path: spec.template.spec.containers[0].resources.limits.memory
          value: "4Gi"
        template: templates/deployment.yaml

  - it: should have startup probe
    asserts:
      - equal:
          path: spec.template.spec.containers[0].startupProbe.httpGet.port
          value: 18789
        template: templates/deployment.yaml
      - equal:
          path: spec.template.spec.containers[0].startupProbe.initialDelaySeconds
          value: 30
        template: templates/deployment.yaml
      - equal:
          path: spec.template.spec.containers[0].startupProbe.failureThreshold
          value: 30
        template: templates/deployment.yaml

  - it: should have liveness probe
    asserts:
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.httpGet.port
          value: 18789
        template: templates/deployment.yaml
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.periodSeconds
          value: 30
        template: templates/deployment.yaml

  - it: should mount PVC when persistence enabled
    set:
      persistence:
        enabled: true
    asserts:
      - contains:
          path: spec.template.spec.volumes
          content:
            name: data
            persistentVolumeClaim:
              claimName: testbot-data
        template: templates/deployment.yaml

  - it: should use emptyDir when persistence disabled
    set:
      persistence:
        enabled: false
    asserts:
      - contains:
          path: spec.template.spec.volumes
          content:
            name: data
            emptyDir: {}
        template: templates/deployment.yaml

  - it: should mount skills volume when skills defined
    set:
      skills:
        test.md: "test content"
    asserts:
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: skills
            mountPath: /config/skills
            readOnly: true
        template: templates/deployment.yaml

  - it: should not mount skills volume when no skills
    asserts:
      - notContains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: skills
            mountPath: /config/skills
            readOnly: true
        template: templates/deployment.yaml

  - it: should set serviceAccountName when rbac enabled
    set:
      rbac:
        create: true
    asserts:
      - equal:
          path: spec.template.spec.serviceAccountName
          value: testbot-devpod
        template: templates/deployment.yaml

  - it: should mount extra configmaps
    set:
      extraConfigMaps:
        - name: agents-registry
          mountPath: /config/agents
          data:
            agents.json: "{}"
    asserts:
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: extra-agents-registry
            mountPath: /config/agents
            readOnly: true
        template: templates/deployment.yaml

  - it: should include extra env vars
    set:
      extraEnv:
        - name: CUSTOM_VAR
          value: "custom-value"
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: CUSTOM_VAR
            value: "custom-value"
        template: templates/deployment.yaml

  - it: should mount workspace volume when workspaceFiles defined
    set:
      workspaceFiles:
        - path: CLAUDE.md
          url: "http://minio.example.com/bucket/workspace/abc/CLAUDE.md?sig=xxx"
    asserts:
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: workspace
            mountPath: /config/workspace
            readOnly: true
        template: templates/deployment.yaml

  - it: should not mount workspace volume when no workspaceFiles
    asserts:
      - notContains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: workspace
            mountPath: /config/workspace
            readOnly: true
        template: templates/deployment.yaml

  - it: should include workspace configmap volume when workspaceFiles defined
    set:
      workspaceFiles:
        - path: CLAUDE.md
          url: "http://minio.example.com/bucket/workspace/abc/CLAUDE.md?sig=xxx"
    asserts:
      - contains:
          path: spec.template.spec.volumes
          content:
            name: workspace
            configMap:
              name: testbot-workspace
        template: templates/deployment.yaml
