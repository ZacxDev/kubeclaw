suite: workflow-configmap
templates:
  - templates/configmap-workflow-skills.yaml
set:
  agentName: testbot
  existingSecret: devpod-secrets
tests:
  - it: should not create ConfigMap when no workflows
    asserts:
      - hasDocuments:
          count: 0

  - it: should not create ConfigMap when all steps use skillRef
    set:
      workflows:
        test-wf:
          schedule: "0 10 * * *"
          steps:
            - name: step1
              skillRef: "/root/.clawdbot/skills/test.md"
    asserts:
      - hasDocuments:
          count: 0

  - it: should create ConfigMap for workflow with inline skills
    set:
      workflows:
        test-wf:
          schedule: "0 10 * * *"
          steps:
            - name: gather
              skill: |
                Gather data from the project.
    asserts:
      - isKind:
          of: ConfigMap
      - equal:
          path: metadata.name
          value: testbot-wf-test-wf

  - it: should set correct namespace
    set:
      workflows:
        test-wf:
          schedule: "0 10 * * *"
          steps:
            - name: gather
              skill: "Gather data"
    asserts:
      - equal:
          path: metadata.namespace
          value: devpod-testbot

  - it: should contain step skill content
    set:
      workflows:
        test-wf:
          schedule: "0 10 * * *"
          steps:
            - name: gather
              skill: |
                Gather data from the project.
    asserts:
      - matchRegex:
          path: data["gather.md"]
          pattern: "Gather data from the project"

  - it: should contain multiple step keys
    set:
      workflows:
        test-wf:
          schedule: "0 10 * * *"
          steps:
            - name: gather
              skill: "Step one instructions"
            - name: synthesize
              skill: "Step two instructions"
    asserts:
      - matchRegex:
          path: data["gather.md"]
          pattern: "Step one"
      - matchRegex:
          path: data["synthesize.md"]
          pattern: "Step two"

  - it: should create separate ConfigMaps per workflow
    set:
      workflows:
        wf1:
          schedule: "0 10 * * *"
          steps:
            - name: step1
              skill: "WF1 skill"
        wf2:
          schedule: "0 12 * * *"
          steps:
            - name: step1
              skill: "WF2 skill"
    asserts:
      - hasDocuments:
          count: 2

  - it: should have workflow label
    set:
      workflows:
        test-wf:
          schedule: "0 10 * * *"
          steps:
            - name: gather
              skill: "Gather data"
    asserts:
      - equal:
          path: metadata.labels["kubeclaw.dev/workflow"]
          value: test-wf
